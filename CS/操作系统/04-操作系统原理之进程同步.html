<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>操作系统原理之进程同步</title>
    <meta name="description" content="100 days to enhance your skills on JavaScript.">
    <link rel="stylesheet" href="/assets/style.8533fe5a.css">
    <link rel="modulepreload" href="/assets/chunks/virtual_search-data.38378a50.js">
    <link rel="modulepreload" href="/assets/chunks/vue3-pdf-embed.fe4be3f4.js">
    <link rel="modulepreload" href="/assets/chunks/vue3-video-player.common.fb9299b2.js">
    <link rel="modulepreload" href="/assets/chunks/vue-codemirror.esm.d8e94f65.js">
    <link rel="modulepreload" href="/assets/chunks/index.cfa69757.js">
    <link rel="modulepreload" href="/assets/chunks/gitalk.eb63aac8.js">
    <link rel="modulepreload" href="/assets/app.65350cb6.js">
    <link rel="modulepreload" href="/assets/CS_操作系统_04-操作系统原理之进程同步.md.dec0a76b.lean.js">
    
    <link rel="shortcut icon" href="/logo/favicon.ico" sizes="any">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#579871">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/logo/apple-touch-icon.png">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-63f8b582><!--[--><!--]--><!--[--><span tabindex="-1" data-v-51c7d2ac></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-51c7d2ac> Skip to content </a><!--]--><!----><header class="VPNav" data-v-63f8b582 data-v-8f5cf07d><div class="VPNavBar has-sidebar" data-v-8f5cf07d data-v-122aa4f8><div class="container" data-v-122aa4f8><div class="VPNavBarTitle has-sidebar" data-v-122aa4f8 data-v-da07d203><a class="title" href="/" data-v-da07d203><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo/favicon-16x16.png" alt data-v-982a05c4><!--]--><!--[-->100 days of JavaScript<!--]--><!--[--><!--]--></a></div><div class="content" data-v-122aa4f8><!--[--><!--]--><div class="VPNavBarSearch search" data-v-122aa4f8><!--teleport start--><!--teleport end--><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><span class="DocSearch-Button-Key">Meta</span><span class="DocSearch-Button-Key">K</span></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-122aa4f8 data-v-34c67e9e><span id="main-nav-aria-label" class="visually-hidden" data-v-34c67e9e>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-34c67e9e data-v-d2d759f4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d2d759f4><span class="text" data-v-d2d759f4><!----> 📂 CS <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-d2d759f4><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-d2d759f4><div class="VPMenu" data-v-d2d759f4 data-v-7261a74c><div class="items" data-v-7261a74c><!--[--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/CS/0-%E5%BC%80%E5%A7%8B%E4%B8%8A%E6%89%8B" data-v-fae0e578 data-v-4990fafc><!--[-->📃 0-开始上手<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/CS/01-VIM%E6%93%8D%E4%BD%9C%E8%A1%A8" data-v-fae0e578 data-v-4990fafc><!--[-->📃 01-VIM操作表<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/0-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BB" data-v-fae0e578 data-v-4990fafc><!--[-->📂 操作系统<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/0-%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86-%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BB" data-v-fae0e578 data-v-4990fafc><!--[-->📂 网络原理<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-34c67e9e data-v-d2d759f4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d2d759f4><span class="text" data-v-d2d759f4><!----> 📂 DSA <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-d2d759f4><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-d2d759f4><div class="VPMenu" data-v-d2d759f4 data-v-7261a74c><div class="items" data-v-7261a74c><!--[--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/DSA/%E5%BC%80%E5%A7%8B%E4%B8%8A%E6%89%8B" data-v-fae0e578 data-v-4990fafc><!--[-->📃 开始上手<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/DSA/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/0-%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BB" data-v-fae0e578 data-v-4990fafc><!--[-->📂 数据结构<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-34c67e9e data-v-d2d759f4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d2d759f4><span class="text" data-v-d2d759f4><!----> 🗳️ More <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-d2d759f4><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-d2d759f4><div class="VPMenu" data-v-d2d759f4 data-v-7261a74c><div class="items" data-v-7261a74c><!--[--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/%E7%A4%BA%E4%BE%8B" data-v-fae0e578 data-v-4990fafc><!--[-->示例<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="/%E5%85%B3%E4%BA%8E" data-v-fae0e578 data-v-4990fafc><!--[-->关于<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-34c67e9e data-v-d2d759f4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-d2d759f4><span class="text" data-v-d2d759f4><!----> ⛓️ Links <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-d2d759f4><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-d2d759f4><div class="VPMenu" data-v-d2d759f4 data-v-7261a74c><div class="items" data-v-7261a74c><!--[--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="https://source.jonsam.site" target="_blank" rel="noreferrer" data-v-fae0e578 data-v-4990fafc><!--[-->源码阅读<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-4990fafc><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="https://dsa.jonsam.site" target="_blank" rel="noreferrer" data-v-fae0e578 data-v-4990fafc><!--[-->Fancy-DSA<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-4990fafc><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="https://ox.jonsam.site" target="_blank" rel="noreferrer" data-v-fae0e578 data-v-4990fafc><!--[-->氧气空间<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-4990fafc><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="http://docs.jonsam.site/project-5/" target="_blank" rel="noreferrer" data-v-fae0e578 data-v-4990fafc><!--[-->深入学习设计模式<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-4990fafc><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7261a74c data-v-fae0e578><a class="VPLink link" href="https://source.jonsam.site/nav" target="_blank" rel="noreferrer" data-v-fae0e578 data-v-4990fafc><!--[-->导航<!--]--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" height="24px" viewbox="0 0 24 24" width="24px" class="icon" data-v-4990fafc><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5H9z"></path></svg></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="https://www.jonsam.site" target="_blank" rel="noreferrer" data-v-34c67e9e data-v-148177db data-v-4990fafc><!--[-->📮 Blog<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-122aa4f8 data-v-132a39fa><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-132a39fa data-v-23f49a49 data-v-641a7590><span class="check" data-v-641a7590><span class="icon" data-v-641a7590><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-23f49a49><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-23f49a49><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-122aa4f8 data-v-34532fbd data-v-a0d6b759><!--[--><a class="VPSocialLink" href="https://github.com/jonsam-ng/100-day-of-js-enhance" target="_blank" rel="noopener" data-v-a0d6b759 data-v-902601b3><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-122aa4f8 data-v-2388b4fb data-v-d2d759f4><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-d2d759f4><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-d2d759f4><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-d2d759f4><div class="VPMenu" data-v-d2d759f4 data-v-7261a74c><!----><!--[--><!--[--><!----><div class="group" data-v-2388b4fb><div class="item appearance" data-v-2388b4fb><p class="label" data-v-2388b4fb>Appearance</p><div class="appearance-action" data-v-2388b4fb><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-2388b4fb data-v-23f49a49 data-v-641a7590><span class="check" data-v-641a7590><span class="icon" data-v-641a7590><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-23f49a49><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-23f49a49><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-2388b4fb><div class="item social-links" data-v-2388b4fb><div class="VPSocialLinks social-links-list" data-v-2388b4fb data-v-a0d6b759><!--[--><a class="VPSocialLink" href="https://github.com/jonsam-ng/100-day-of-js-enhance" target="_blank" rel="noopener" data-v-a0d6b759 data-v-902601b3><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-122aa4f8 data-v-84ae7409><span class="container" data-v-84ae7409><span class="top" data-v-84ae7409></span><span class="middle" data-v-84ae7409></span><span class="bottom" data-v-84ae7409></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-63f8b582 data-v-986ae53f><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-986ae53f><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-986ae53f><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-986ae53f>Menu</span></button><a class="top-link" href="#" data-v-986ae53f> Return to top </a></div><aside class="VPSidebar" data-v-63f8b582 data-v-aeceacfc><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-aeceacfc><span class="visually-hidden" id="sidebar-aria-label" data-v-aeceacfc> Sidebar Navigation </span><!--[--><div class="group" data-v-aeceacfc><section class="VPSidebarGroup collapsible" data-v-aeceacfc data-v-991b9bc9><div class="title" role="button" data-v-991b9bc9><h2 class="title-text" data-v-991b9bc9>📂 CS</h2><div class="action" data-v-991b9bc9><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-991b9bc9><!--[--><!--[--><a class="VPLink link link" href="/CS/0-%E5%BC%80%E5%A7%8B%E4%B8%8A%E6%89%8B" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 0-开始上手</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/01-VIM%E6%93%8D%E4%BD%9C%E8%A1%A8" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 01-VIM操作表</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-aeceacfc><section class="VPSidebarGroup collapsible" data-v-aeceacfc data-v-991b9bc9><div class="title" role="button" data-v-991b9bc9><h2 class="title-text" data-v-991b9bc9>📂 操作系统</h2><div class="action" data-v-991b9bc9><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-991b9bc9><!--[--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/0-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BB" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 0-操作系统-开始阅读</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/00-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E6%A6%82%E8%BF%B0" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 00-操作系统原理之概述</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/01-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 01-操作系统原理之进程与线程</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/02-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8BCPU%E8%B0%83%E5%BA%A6" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 02-操作系统原理之CPU调度</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/03-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 03-操作系统原理之调度算法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/04-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 04-操作系统原理之进程同步</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E6%AD%BB%E9%94%81" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 05-操作系统原理之死锁</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/06-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 06-操作系统原理之内存管理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/07-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 07-操作系统原理之文件系统</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E7%A3%81%E7%9B%98%E8%B0%83%E5%BA%A6" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 08-操作系统原理之磁盘调度</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-aeceacfc><section class="VPSidebarGroup collapsible" data-v-aeceacfc data-v-991b9bc9><div class="title" role="button" data-v-991b9bc9><h2 class="title-text" data-v-991b9bc9>📂 网络原理</h2><div class="action" data-v-991b9bc9><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-991b9bc9><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-991b9bc9><!--[--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/0-%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86-%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BB" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 0-网络原理-开始阅读</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/00-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E6%A6%82%E8%BF%B0" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 00-计算机网络原理之概述</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/01-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E7%89%A9%E7%90%86%E5%B1%82" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 01-计算机网络原理之物理层</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/02-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 02-计算机网络原理之数据链路层</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/03-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E7%BD%91%E7%BB%9C%E5%B1%82" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 03-计算机网络原理之网络层</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E4%BC%A0%E8%BE%93%E5%B1%82" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 04-计算机网络原理之传输层</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/CS/%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86/05-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86%E4%B9%8B%E5%BA%94%E7%94%A8%E5%B1%82" style="padding-left:0px;" data-v-33738aa2 data-v-4990fafc><!--[--><span class="link-text" data-v-33738aa2>📃 05-计算机网络原理之应用层</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-63f8b582 data-v-431161ac><div class="VPDoc has-sidebar has-aside" data-v-431161ac data-v-16f25ed6><div class="container" data-v-16f25ed6><div class="aside" data-v-16f25ed6><div class="aside-curtain" data-v-16f25ed6></div><div class="aside-container" data-v-16f25ed6><div class="aside-content" data-v-16f25ed6><div class="VPDocAside" data-v-16f25ed6 data-v-9822eb1b><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-9822eb1b data-v-12a7ca3a><div class="content" data-v-12a7ca3a><div class="outline-marker" data-v-12a7ca3a></div><div class="outline-title" data-v-12a7ca3a>🔗 内容纲要：</div><nav aria-labelledby="doc-outline-aria-label" data-v-12a7ca3a><span class="visually-hidden" id="doc-outline-aria-label" data-v-12a7ca3a> Table of Contents for current page </span><ul class="root" data-v-12a7ca3a data-v-501ed047><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-9822eb1b></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-16f25ed6><div class="content-container" data-v-16f25ed6><!--[--><!--]--><main class="main" data-v-16f25ed6><div style="position:relative;" class="vp-doc _CS_%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F_04-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5" data-v-16f25ed6><div><h1 id="操作系统原理之进程同步" tabindex="-1">操作系统原理之进程同步 <a class="header-anchor" href="#操作系统原理之进程同步" aria-hidden="true">#</a></h1><div class="badge-group" data-v-4ecad2c5><span class="group-tag" data-v-4ecad2c5>标签：</span><!--[--><span class="badge tip" style="vertical-align:middle;" data-v-4ecad2c5 data-v-dd429f7e>操作系统原理</span><!--]--></div><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-hidden="true">#</a></h2><nav class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#进程程同步简介">进程程同步简介</a><ul><li><a href="#peterson方法">Peterson方法</a></li><li><a href="#信号量（semaphores）">信号量（Semaphores）</a></li></ul></li><li><a href="#同步临界区">同步临界区</a><ul><li><a href="#什么是临界区？">什么是临界区？</a></li><li><a href="#原子操作">原子操作</a></li></ul></li><li><a href="#进程间通信（ipc）">进程间通信（IPC）</a><ul><li><a href="#共享内存法">共享内存法</a></li><li><a href="#信息传递法">信息传递法</a></li><li><a href="#ipc系统的例子">IPC系统的例子</a></li></ul></li><li><a href="#semaphores信息量">Semaphores信息量</a><ul><li><a href="#信号量的类型">信号量的类型</a></li><li><a href="#p操作和v操作">P操作和V操作</a></li><li><a href="#二元信号量">二元信号量</a></li><li><a href="#计数信号量">计数信号量</a></li></ul></li><li><a href="#mutex-vs-semaphore">Mutex vs Semaphore</a><ul><li><a href="#生产者-消费者的问题">生产者/消费者的问题</a></li><li><a href="#误区">误区</a></li><li><a href="#常见问题">常见问题</a></li><li><a href="#参考">参考</a></li></ul></li><li><a href="#生产者和消费者问题">生产者和消费者问题</a></li><li><a href="#用餐哲学家问题">用餐哲学家问题</a></li><li><a href="#睡眠理发师问题">睡眠理发师问题</a></li><li><a href="#读写同步问题">读写同步问题</a></li></ul></nav><h2 id="进程程同步简介" tabindex="-1">进程程同步简介 <a class="header-anchor" href="#进程程同步简介" aria-hidden="true">#</a></h2><p>在同步（synchronization）的基础上，进程被分为以下两种类型：</p><ul><li>独立进程（Independent Process）。一个进程的执行并不影响其他进程的执行。</li><li>合作进程（Cooperative Process）。一个进程可以影响或被系统中执行的其他进程所影响。</li></ul><p>在合作进程的情况下会出现进程同步问题，因为在合作进程中资源是共享的。</p><p>条件竞争（Race Condition）：</p><p>当一个以上的进程执行相同的代码或访问相同的内存或任何共享变量时，在这种情况下，输出或共享变量的值有可能是错误的，因此，所有的进程都在进行资源竞争，这种情况被称为条件竞争（race condition）。几个进程同时访问和处理同一数据的操作，那么结果就取决于访问发生的特定顺序。竞争条件可能发生在临界区中，当临界区的多个线程执行的结果因线程的执行顺序不同而发生。如果把临界区作为一个原子指令（atomic instruction）来处理，就可以避免临界区的条件竞争。此外，使用锁或原子变量（atomic variables）进行适当的线程同步（thread synchronization）也可以防止出现条件竞争。</p><p>临界区（Critical Section）问题：临界区是一个代码段，一次只能由一个进程访问。临界区包含需要同步的共享变量，以保持数据变量的一致性（consistency）。因此，关键部段问题意味着为合作进程需要设计一种访问共享资源而不产生数据不一致的方法。</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1uwxrz2dhcxs.webp" alt="临界区" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1uwxrz2dhcxs.webp"></p><p>在入口（entry section）部分，进程在进入临界区之前需要请求进入。任何解决临界区问题的方案都必须满足三个要求：</p><ul><li>相互排斥（Mutual Exclusion）。如果一个进程在其临界区执行，那么其他进程就不允许在临界区执行。</li><li>进展（Progress）。如果没有进程在临界区执行，而其他进程在临界区之外等待，那么只有那些没有在其剩余部分（remainder section）执行的进程可以参与决定下一个进入临界区的进程，而且这种选择不能无限期地推迟（postponed indefinitely）。</li><li>有限等待（Bounded Waiting）。在一个进程提出进入其临界区的请求后，在该请求被批准之前，允许其他进程进入其临界区的次数必须存在一个约束。</li></ul><h3 id="peterson方法" tabindex="-1">Peterson 方法 <a class="header-anchor" href="#peterson方法" aria-hidden="true">#</a></h3><p>彼得森的解决方案是一个经典的基于软件的临界区（critical section）问题的解决方案。在彼得森的解决方案中，我们有两个共享变量：</p><ul><li><code>boolean flag[i]</code> 。初始化为 FALSE，最初没有进程对进入临界区感兴趣。</li><li><code>int turn</code> 。轮到进入临界区的进程。</li></ul><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2altqt84gow0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2altqt84gow0.webp"></p><p>彼得森的解决方案保留了所有三个条件：</p><ul><li>相互排斥得到了保证，因为在任何时候只有一个进程可以访问临界区。</li><li>进度也得到保证，因为在临界区之外的进程不会阻止其他进程进入临界区。</li><li>由于每个进程都有公平的机会，因此保留了有限的等待。</li></ul><p>彼得森解决方案的缺点：</p><ul><li>导致繁忙等待（busy waiting）。(在 Peterson 的解决方案中，代码声明 <code>while(flag[j] &amp;&amp; turn == j)</code> 要对此负责。忙碌的等待是不受欢迎的，因为它浪费了可以用来执行其他任务的 CPU 周期（CPU cycles））。</li><li>它被限制在 2 个进程。</li><li>彼得森的解决方案不能用于现代 CPU 架构（modern CPU architectures）。</li></ul><h3 id="信号量（semaphores）" tabindex="-1">信号量（Semaphores） <a class="header-anchor" href="#信号量（semaphores）" aria-hidden="true">#</a></h3><p>信号量是一种信号机制（signaling mechanism），一个正在等待信号量的线程可以被另一个线程发出信号。这与 mutex（互斥锁）不同，因为 mutex 只能由被调用等待函数（wait function）的线程发出信号。</p><p>一个 semaphore 使用两个<strong>原子操作</strong>（atomic operations），进程同步的等待（wait）和信号（signal）。一个 semaphore 是一个整数变量，它只能通过 wait () 和 signal () 两个操作来访问。</p><p>有两种类型的 semaphores：二进制 semaphores 和计数 semaphores。</p><ul><li>二进制 semaphores（Binary Semaphores）：它们只能是 0 或 1。它们也被称为<strong>互斥锁</strong>（mutex locks），因为该锁可以提供互斥（mutual exclusion）。所有的进程可以共享同一个初始化为 1 的互斥信号，然后，一个进程必须等待，直到锁变成 0。当它完成其临界区时，它可以将 mutex semaphore 的值重置为 0，其他进程可以进入临界区。</li><li>计数 semaphores（Counting Semaphores）：它们可以有任何值，并且不受限于某个领域。它们可以用来控制对某一资源的访问，该资源对同时访问（simultaneous accesses）的次数有限制。该信号可以被初始化为该资源的实例数。每当一个进程想使用该资源时，它就会检查剩余实例的数量是否超过零，也就是说，该进程是否有可用的实例。然后，该进程可以进入其临界区，从而使计数信号的值减少 1。在该进程结束对资源实例的使用后，它可以离开临界区，从而使资源的可用实例数增加 1。</li></ul><h2 id="同步临界区" tabindex="-1">同步临界区 <a class="header-anchor" href="#同步临界区" aria-hidden="true">#</a></h2><h3 id="什么是临界区？" tabindex="-1">什么是临界区？ <a class="header-anchor" href="#什么是临界区？" aria-hidden="true">#</a></h3><p>当一个以上的进程访问同一个代码段时，该段被称为关键段（critical section，临界区）。</p><p>临界区包含需要同步的共享变量或资源，以保持数据变量的一致性。简单来说，临界区是一组需要原子化（atomically）执行的指令 / 语句或代码区域，比如访问一个资源（文件、输入或输出端口、全局数据等）。在并发编程（concurrent programming）中，如果一个线程试图改变共享数据的值，同时另一个线程试图读取该值（即跨线程的数据竞争，data race across threads），结果是不可预测的。对这种共享变量（共享内存、共享文件、共享端口等......）的访问是要同步（synchronized）的。很少有编程语言对同步化（synchronization）有内置支持。在编写内核模式程序（kernel-mode programming）（设备驱动程序、内核线程等）时，理解条件竞争（race conditions）的重要性至关重要，因为程序员可以直接访问和修改内核的数据结构。</p><p>它可以用下面的伪代码进行可视化：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">do</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    flag</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">flag</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;"> // (entry section)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// critical section</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#F07178;">flag</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// remainder section</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对临界区的简单解决方案可以考虑如下：</p><div class="language-txt line-numbers-mode"><button class="copy"></button><span class="lang">txt</span><pre><code><span class="line"><span style="color:#A6ACCD;">acquireLock();</span></span>
<span class="line"><span style="color:#A6ACCD;">Process Critical Section</span></span>
<span class="line"><span style="color:#A6ACCD;">releaseLock();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>一个线程在执行临界区之前必须获得一个锁。该锁只能由一个线程获得。在上述伪代码中，有多种方法来实现锁。</p><h3 id="原子操作" tabindex="-1">原子操作 <a class="header-anchor" href="#原子操作" aria-hidden="true">#</a></h3><p>什么是原子操作（atomic operation）？原子操作的概念有助于理解重入（reentrancy）、临界区（critical section）、线程安全（thread safety）、同步原语（synchronization primitives）等。</p><p>原子性和原子操作：</p><p>简单来说，原子性（atomicity）就是不可中断性（unbreakability），也就是不间断的操作（uninterrupted operation）。如果两个用户发出一个打印命令，每一次打印都应该是单次尝试（single attempt）。如果打印机驱动程序同时从两个用户那里发送部分数据，那么打印出来的结果将不符合预期。因此，打印机驱动程序必须将打印命令作为不可中断的操作从一个应用程序中发送出去（换句话说，同步访问打印机）。</p><p>请注意，关于原子性的数据库术语会有所不同，但概念是相同的。</p><p>原子操作的一个典型例子是指令的执行，通常情况下，给执行单元（execution unit）的指令不可能在中间停止。然而，高级语言中的一条语句会产生多条指令，这是非原子性操作（non-atomic operations）的根本原因。</p><h2 id="进程间通信（ipc）" tabindex="-1">进程间通信（IPC） <a class="header-anchor" href="#进程间通信（ipc）" aria-hidden="true">#</a></h2><p>一个进程可以有两种类型：</p><ul><li>独立进程（Independent process）</li><li>合作进程（Co-operating process）</li></ul><p>一个独立的进程不受其他进程执行的影响，而一个合作的进程可能受到其他执行进程的影响。尽管人们可以认为那些独立运行的进程会非常有效地执行，但在现实中，有许多情况下可以利用合作的特性（co-operative nature）来提高计算速度、便利性和模块化（modularity）。进程间通信（IPC，Inter-process communication）是一种机制，它允许进程之间相互通信并同步其行动（synchronize their actions）。这些进程之间的通信可以被看作是它们之间的一种合作。进程之间可以通过以下两种方式进行通信：</p><ul><li>共享内存（Shared Memory）</li><li>消息传递（Message passing）</li></ul><p>一个操作系统可以实现这两种通信方法。首先，我们将讨论共享内存的通信方法，然后是消息传递。</p><p>使用共享内存的进程之间的通信需要进程共享一些变量，这完全取决于程序员将如何实现它。使用共享内存的一种通信方式可以是这样：假设进程 1 和进程 2 同时（simultaneously）执行，它们共享一些资源或使用另一个进程的一些信息。进程 1 产生关于某些计算或资源被使用的信息，并将其作为记录保存在共享内存（shared memory）中。当进程 2 需要使用共享信息时，它将在存储在共享内存中的记录中检查，并注意到进程 1 生成的信息，并采取相应的行动（act accordingly）。进程可以使用共享内存从另一个进程中提取信息作为记录，以及向其他进程传递任何特定信息。</p><p>让我们来讨论一个使用共享内存方法（Shared Memory Method）的进程间通信的例子：</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2rr3htna2po0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2rr3htna2po0.webp"></p><h3 id="共享内存法" tabindex="-1">共享内存法 <a class="header-anchor" href="#共享内存法" aria-hidden="true">#</a></h3><p>例如：生产者 - 消费者问题（Producer-Consumer problem）</p><p>有两个进程：生产者和消费者。生产者生产一些物品，消费者消费该物品。这两个进程共享一个共同的空间或内存位置，称为缓冲区（buffer），生产者生产的物品存放在这里，如果需要，消费者从这里消费该物品。</p><p>这个问题有两个版本：第一个版本被称为<strong>无界缓冲区问题</strong>（unbounded buffer problem），在这个问题中，生产者可以不断地生产物品，并且对缓冲区的大小没有限制；第二个版本被称为<strong>有界缓冲区问题</strong>（bounded buffer problem），在这个问题中，生产者在开始等待消费者消费之前可以生产一定数量的物品。我们将讨论有界缓冲区问题。</p><p>首先，生产者和消费者将共享一些共同的内存，然后生产者将开始生产物品。如果生产的项目总数等于缓冲区的大小，生产者将等待让消费者消费它。同样地，消费者将首先检查项目的可用性，如果没有可用的物品，消费者将等待生产者生产它。如果有可用的项目，消费者将消费它们。下面提供了演示的伪代码。</p><p>两个进程之间的共享数据：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">buff_max</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mod</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> item</span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// different member of the produced data</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// or consumed data</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">---------</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// An array is needed for holding the items.</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// This is the shared place which will be</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// access by both process</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// item shared_buff [ buff_max ];</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// Two variables which will keep track of</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// the indexes of the items produced by producer</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// and consumer The free index points to</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// the next free index. The full index points to</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// the first full index.</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> free_index </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> full_index </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>生产者进程代码：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">item nextProduced</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// check if there is no space</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// for production.</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// if so keep waiting.</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// free_index 的下一个坐标（环形）是full_index，说明从 free_index 到 full_index</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 已经占满了数组，新的产品将没有位置放置</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">free_index</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> mod buff_max </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> full_index</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 生产新的产品并放入产品池</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">shared_buff</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">free_index</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> nextProduced</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 后移 free_index（环形）</span></span>
<span class="line"><span style="color:#F07178;">  free_index </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">free_index </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> mod buff_max</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>消费者进程代码：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">item nextConsumed</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// check if there is an available</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// item for consumption.</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// if not keep on waiting for</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// get them produced.</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// free_index 与 full_index 重合表示没有产品池中已经没有产品</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">free_index </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> full_index</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// 消费池中生产日期最长的产品</span></span>
<span class="line"><span style="color:#F07178;">  nextConsumed </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">shared_buff</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">full_index</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// full_index 后移（环形）</span></span>
<span class="line"><span style="color:#F07178;">  full_index </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">full_index </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> mod buff_max</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> }</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在上面的代码中，当 <code>(free_index+1) mod buff max</code> 是空的时候，生产者将再次开始生产，因为如果它不是空的，这意味着仍然有项目可以被消费者消费，所以不需要生产更多。同样地，如果 <code>free index</code> 和 <code>full index</code> 指向同一个索引，这意味着没有物品可以消费。</p><h3 id="信息传递法" tabindex="-1">信息传递法 <a class="header-anchor" href="#信息传递法" aria-hidden="true">#</a></h3><p>现在，我们将开始讨论进程之间通过消息传递进行通信的问题。在这种方法中，进程之间的通信不需要使用任何种类的共享内存。如果两个进程 p1 和 p2 想相互通信，它们的程序如下：</p><ul><li>建立一个通信链路（communication link）（如果一个链路已经存在，不需要再建立）。</li><li>开始使用基本原语（basic primitives）交换信息。我们至少需要两个原语。 <ul><li><code>send(message, destination)</code> 或 <code>send(message)</code></li><li><code>receive(message, host)</code> 或 <code>receive(message)</code></li></ul></li></ul><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.4ac8p7ws45e0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.4ac8p7ws45e0.webp"></p><p>信息大小可以是固定的，也可以是可变大小的。如果是固定大小，对操作系统设计者来说很容易，但对程序员来说很复杂；如果是可变大小，对程序员来说很容易，但对操作系统设计者来说很复杂。一个标准的消息可以有两个部分：消息头部（header）和消息体（body）。消息头部用于存储消息类型（message type）、目的地 ID（destination id）、源 ID（source id）、消息长度（message length）和控制信息（control information）。控制信息包含的信息有：缓冲区空间（buffer space）用尽的处理措施、序列号（sequence number）、优先级（priority）。一般来说，消息是以先进先出的方式（FIFO）发送的。</p><h4 id="通信链路传递消息" tabindex="-1">通信链路传递消息 <a class="header-anchor" href="#通信链路传递消息" aria-hidden="true">#</a></h4><p>直接和间接通信链路（Communication Link）：</p><p>现在，我们将开始讨论实现通信链路的方法。在实现链接时，有一些问题需要牢记在心，比如:</p><ul><li>链接是如何建立的？</li><li>一个链路可以与两个以上的进程相关联（associated）吗？</li><li>每一对通信进程之间可以有多少个链路？</li><li>链接的容量（capacity）是多少？链接所能容纳的信息的大小是固定的还是可变的？</li><li>一个链接是单向的还是双向的（unidirectional or bi-directional）？</li></ul><p>一个链路有一定的容量（capacity），它决定了可以暂时驻留在其中的消息数量，为此，每个链路都有一个与之相关的队列（queue），可以是零容量（zero capacity）、有限界容量（bounded capacity）或无线容量（unbounded capacity）。在零容量的情况下，发送方等待直到接收方通知发送方它已经收到消息。在非零容量（non-zero capacity）的情况下，一个进程在发送操作后不知道对方是否已经收到了消息。为此，发送方必须与接收方进行明确的沟通。链接（link）的实现取决于实际情况（situation），它可以是直接通信链接（direct communication link），也可以是间接通信链接（in-directed communication link）。</p><p>当进程使用特定的进程标识符（process identifier）进行通信，但很难提前识别发送方时，就可以实现直接通信链接（Direct Communication links）。例如，打印服务器。</p><p>间接通信（In-direct Communication）是通过一个共享邮箱（端口，port）进行的，它由一个消息队列组成。发送者把消息放在邮箱（端口内的消息队列）里，接收者把它们取出来。</p><h4 id="交换信息传递信息" tabindex="-1">交换信息传递信息 <a class="header-anchor" href="#交换信息传递信息" aria-hidden="true">#</a></h4><p>同步和异步的消息传递：</p><p>一个被阻塞的进程可能是被事件阻塞，如资源的可用性或 I/O 操作的完成。IPC 可以在同一台计算机上的进程之间进行，也可以在不同计算机上运行的进程之间进行，即在网络 / 分布式系统（networked/distributed system）中。在这两种情况下，进程在发送消息或试图接收消息时可能会被阻塞，也可能不会被阻塞，因此消息传递可能是阻塞或非阻塞的（blocking or non-blocking）。</p><p>阻断被认为是同步（synchronous）的，阻塞式发送意味着发送者将被阻断，直到消息被接收者收到。同样地，阻塞式接收让接收者阻塞，直到有消息可用。非阻塞被认为是异步（asynchronous）的，非阻塞式发送是指发送者发送消息并继续工作。同样地，非阻塞式接收让接收者收到有效的信息或空信息。</p><p>经过仔细的分析，我们可以得出一个结论，对于发送方来说，在消息传递之后，非阻塞是比较自然的，因为可能需要将消息发送到不同的进程。然而，发送方希望在发送失败的情况下得到接收方的确认。同样地，接收者在报告接收后处于阻塞状态是更自然的，因为收到的消息中的信息可能会被用于进一步的执行。同时，如果消息发送不断失败，接收方将不得不无限期（indefinitely）地等待。这就是为什么我们还要考虑消息传递的其他可能性。基本上有三种首选组合：</p><ul><li>阻塞式发送和阻塞式接收</li><li>非阻塞式发送和非阻塞式接收</li><li>非阻塞式发送和阻塞式接收（多数情况下使用）。</li></ul><p>在直接消息传递中，想要进行通信的进程必须明确命名通信的接收者或发送者。例如， <code>send(p1, message)</code> 意味着向 p1 发送消息。类似地， <code>receive(p2, message)</code> 意味着从 p2 接收消息。</p><p>在这种通信方法中，通信链路自动建立，可以是单向的（unidirectional），也可以是双向的（bidirectional），但一对发送者和接收者之间可以使用一条链路，一对发送者和接收者不应该拥有超过一对链路。</p><p>发送和接收之间的对称性（symmetry）和非对称性（asymmetry）也可以实现，即要么两个进程在发送和接收信息时相互命名，要么只有发送方在发送信息时命名接收方，接收方在接收信息时不需要命名发送方。这种通信方法的问题是，如果一个进程的名称发生变化，这种方法将无法工作。</p><p>在间接消息传递中，进程使用邮箱（也被称为端口）来发送和接收消息。每个邮箱都有一个唯一的 ID，进程只有在共享一个邮箱时才能通信。只有当进程共享一个共同的邮箱时才建立链接，而且一个链接可以与许多进程相关联。每对进程可以共享几个通信链接，这些链接可以是单向的或双向的。</p><p>假设两个进程想通过间接消息传递进行通信，所需的操作是：创建一个邮箱，使用该邮箱发送和接收消息，然后销毁该邮箱。使用的标准原语是： <code>send(A, message)</code> ，这意味着将消息发送到邮箱 A。接收消息的原语也以同样的方式工作，例如： <code>received (A, message)</code> 。这个邮箱的实现有一个问题。假设有两个以上的进程共享同一个邮箱，并且假设进程 p1 向邮箱发送了一个消息，那么哪个进程将是接收方？这可以通过以下方式解决：</p><p>强制规定只有两个进程可以共享一个邮箱，或者强制规定在给定时间内只允许一个进程执行接收，或者随机选择任何一个进程并通知发送方为接收方。一个邮箱可以成为单个发送方 / 接收方对的私有邮箱，也可以在多个发送方 / 接收方对之间共享。端口（Port）是这种邮箱的一个实现，可以有多个发送方和一个接收方。它被用于客户端 / 服务器应用程序（在这种情况下，服务器是接收方）。端口由接收进程拥有，并由操作系统在接收进程的请求下创建，并且可以在接收者自身终止时，在同一接收处理器的请求下销毁。强制执行只有一个进程被允许执行接收，可以使用互斥（mutual exclusion）的概念来完成。互斥邮箱（Mutex mailbox）被创建，由 n 个进程共享。发送者是无阻塞的，并发送消息。第一个执行接收的进程将进入临界区，所有其他进程将处于阻塞状态并等待。</p><p>现在，让我们用消息传递的概念来讨论生产者 - 消费者问题。生产者在邮箱中放置项目（消息），当邮箱中至少有一条消息时，消费者就可以消费一个项目。以下是代码：</p><p>生产者代码：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Producer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> item</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  Message m</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">receive</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Consumer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">m</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">   item </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">produce</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">build_message</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">m </span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> item</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Consumer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">m</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>消费者代码：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Consumer</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> item</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  Message m</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">receive</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Producer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">m</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">   item </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">extracted_item</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Producer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">m</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">consume_item</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">item</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="ipc系统的例子" tabindex="-1">IPC 系统的例子 <a class="header-anchor" href="#ipc系统的例子" aria-hidden="true">#</a></h3><p>IPC 系统的例子如下：</p><ul><li>Posix：使用共享内存法</li><li>Mach : 使用信息传递法</li><li>Windows XP：使用本地过程调用（local procedural calls）的消息传递方式</li></ul><p>客户 / 服务器结构（client/server Architecture）中的通信机制：</p><ul><li>管道（Pipe）</li><li>套接字（Socket）</li><li>远程过程调用（RPC，Remote Procedural calls）</li></ul><h2 id="semaphores信息量" tabindex="-1">Semaphores 信息量 <a class="header-anchor" href="#semaphores信息量" aria-hidden="true">#</a></h2><p>Semaphore 是由 Dijkstra 在 1965 年提出的，这是一项非常重要的技术，通过使用一个简单的整数值来管理并发进程（concurrent processes），这就是所谓的 semaphore。semaphore 是一个简单的整数变量，在线程之间共享。这个变量被用来解决临界区的问题，并在多进程（multiprocessing）环境中实现进程的同步（synchronization）。</p><h3 id="信号量的类型" tabindex="-1">信号量的类型 <a class="header-anchor" href="#信号量的类型" aria-hidden="true">#</a></h3><p>Semaphores 有两种类型：</p><ul><li>二进制信息量（Binary Semaphore，二元信号量）： 这也被称为 mutex 锁。它只能有两个值 --0 和 1。它的值被初始化为 1。它被用来实现解决多进程的临界区问题。</li><li>计数信息量（Counting Semaphore）：它的值可以在一个不受限制的范围内。它被用来控制对有多个实例的资源的访问。</li></ul><p>现在让我们看看它是如何做到这一点的。</p><h3 id="p操作和v操作" tabindex="-1">P 操作和 V 操作 <a class="header-anchor" href="#p操作和v操作" aria-hidden="true">#</a></h3><p>首先，看一下可以用来访问和改变 semaphore 变量值的两个操作：</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2hpmvwgp1dw0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2hpmvwgp1dw0.webp"></p><p>关于 P 和 V 操作的一些重点：</p><ul><li>P 操作（P operation）也被称为等待（wait）、睡眠（sleep）或下降（down）操作，而 V 操作（V operation）也被称为信号（signal）、唤醒（wake-up）或上升（up）操作。</li><li>这两个操作都是<strong>原子操作</strong>，并且信号量总是被初始化为一个，即 s=1。这里的原子性是指在同一时间 / 时刻对变量进行读取、修改和更新，没有抢占，也就是说，在读取、修改和更新之间，没有其他操作会改变该变量。</li><li>一个临界区被这两个操作所包围，以实现进程同步。请看下面的图片。进程 P 的临界区位于 P 和 V 操作之间。</li></ul><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.92870j30ebc.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.92870j30ebc.webp"></p><h3 id="二元信号量" tabindex="-1">二元信号量 <a class="header-anchor" href="#二元信号量" aria-hidden="true">#</a></h3><p>现在，让我们看看它是如何实现互斥的。假设有两个进程 P1 和 P2，semaphore s 被初始化为 1。现在，如果假设 P1 进入了它的临界区，那么 semaphore s 的值就变成了 0。这样就实现了互斥。请看下面的图片，这就是二进制信号量。</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.k5slr66idkg.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.k5slr66idkg.webp"></p><p>Binary semaphores 的实现：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> semaphore </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#C792EA;">enum</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">value</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// q contains all Process Control Blocks (PCBs)</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// corresponding to processes got blocked</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// while performing down operation.</span></span>
<span class="line"><span style="color:#F07178;"> Queue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">process</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> q</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">P</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">semaphore </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// add the process to the waiting queue</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">P</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#82AAFF;">V</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Semaphore </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">q</span><span style="color:#F07178;"> is empty</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// select a process from waiting queue</span></span>
<span class="line"><span style="color:#F07178;">  Process p </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">front</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// remove the process from wating as it has been</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// sent for CS</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">pop</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">wakeup</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>局限性:</p><ul><li>信号量最大的限制之一是优先级倒置（priority inversion）。</li><li>死锁（Deadlock），假设一个进程试图唤醒另一个不在睡眠状态的进程。因此，一个死锁可能会无限期地阻塞。</li><li>操作系统必须跟踪所有调用等待和信号的 semaphore。</li></ul><p>在这个实现 semaphore 的过程中存在问题：</p><p>semaphores 的主要问题是它需要繁忙的等待，如果一个进程处于临界区，那么其他试图进入临界区的进程将一直等待，直到临界区没有被任何进程占据。每当有进程等待时，它就会不断地检查 semaphore 的值（请看在 P 操作中这一行 <code>while (s==0);</code> ），并浪费 CPU 周期（CPU cycle）。</p><p>上面的描述是针对二进制信号量的，它只能取 0 和 1 两个值，并确保相互排斥。还有一种类型的信号灯叫做计数信号量，可以取大于 1 的值。</p><h3 id="计数信号量" tabindex="-1">计数信号量 <a class="header-anchor" href="#计数信号量" aria-hidden="true">#</a></h3><p>现在假设有一种资源，其实例数为 4，现在我们初始化 S=4，其余部分与二进制信号量相同。每当进程需要该资源时，它就会调用 P 或等待函数，当它完成后，就会调用 V 或信号函数。如果 S 的值变成了 0，那么一个进程必须等待，直到 S 变成正值。例如，假设有 4 个进程 P1、P2、P3、P4，它们都对 S（初始化为 4）调用等待操作。如果另一个进程 P5 想要这个资源，那么它应该等待，直到这四个进程中的一个调用信号函数，并且 semaphore 的值变为正值。</p><p>在等待锁的过程中，也有可能出现 &quot;自旋锁&quot;（spinlock），因为这些进程不断地旋转（spin）。为了避免这种情况，下面提供了另一种实现，计数信号量的实现：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> Semaphore </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// q contains all Process Control Blocks(PCBs)</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// corresponding to processes got blocked</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// while performing down operation.</span></span>
<span class="line"><span style="color:#F07178;"> Queue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">process</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> q</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">P</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Semaphore </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// add process to queue</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// here p is a process which is currently executing</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">block</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">V</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Semaphore </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// remove process p from queue</span></span>
<span class="line"><span style="color:#F07178;">  Process p </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">q</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">pop</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">wakeup</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在这个实现中，每当进程等待时，它就会被加入到与该信号相关的进程的等待队列中。这是在该进程上通过系统调用 block () 完成的。当一个进程完成后，它会调用信号函数，队列中的一个进程会被恢复。它使用 wakeup () 系统调用。</p><h2 id="mutex-vs-semaphore" tabindex="-1">Mutex vs Semaphore <a class="header-anchor" href="#mutex-vs-semaphore" aria-hidden="true">#</a></h2><p>mutex 和 semaphore 之间的区别是什么？什么时候应该使用 mutex，什么时候应该使用 semaphore？</p><p>按照操作系统的术语，mutexes 和 semaphores 是提供同步服务（synchronization services，也叫同步原语，synchronization primitives）的内核资源（kernel resources）。为什么我们需要这样的同步原语？只有一个不就够了吗？为了回答这些问题，我们需要了解一些核心概念。</p><h3 id="生产者-消费者的问题" tabindex="-1">生产者 / 消费者的问题 <a class="header-anchor" href="#生产者-消费者的问题" aria-hidden="true">#</a></h3><p>请注意，该内容是一个概括性的解释。实际细节因场景而异。</p><p>考虑一下标准的生产者 - 消费者问题。假设，我们有一个长度为 4096 字节的缓冲区。一个生产者线程收集数据并将其写入缓冲区。一个消费者线程处理从缓冲区收集的数据。目标是，这两个线程不应该同时运行。</p><p>使用 Mutex：</p><p>Mutex 提供相互排斥（mutual exclusion），生产者或消费者都可以拥有钥匙（Mutex）并继续他们的工作。只要缓冲区被生产者填满，消费者就需要等待，反之亦然。在任何时间点，只有一个线程可以处理整个缓冲区。这个概念可以用 semaphore 来概括。</p><p>使用 semaphore：</p><p>semaphore 是一个通用的 mutex。为了代替单个缓冲区，我们可以将 4KB 的缓冲区分成四个 1KB 的缓冲区（相同的资源）。一个 semaphore 可以与这四个缓冲区相关联。消费者和生产者可以同时在不同的缓冲区工作。</p><h3 id="误区" tabindex="-1">误区 <a class="header-anchor" href="#误区" aria-hidden="true">#</a></h3><p>在二进制信号量和 mutex 之间存在一个模糊的概念。我们可能遇到过，mutex 是一个二进制信号量。但事实并非如此。mutex 和 semaphore 的目的是不同的。也许，由于它们在实现上的相似性，mutex 会被称为二进制信号量。</p><p>严格来说，mutex 是一种锁定机制，用于同步访问一个资源。只有一个任务（可以是线程，也可以是基于操作系统抽象的进程）可以获得该 mutex。这意味着有所有权与 mutex 相关联，并且只有所有者可以释放锁（mutex）。</p><p>semaphore 是一种信号机制（ignaling mechanism）（&quot;我完成了，你可以继续&quot; 的信号）。例如，如果你在手机上听歌（假设是一个任务），同时你的朋友给你打电话，就会触发一个中断，中断服务程序（ISR）就会给呼叫处理任务发出唤醒信号。</p><h3 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-hidden="true">#</a></h3><ol><li><p>一个线程可以获得一个以上的锁（Mutex）吗？是的，一个线程有可能需要一个以上的资源，因此要有锁。如果任何锁不可用，线程将在锁上等待（阻塞，wait (block)）。</p></li><li><p>一个 mutex 可以被锁定一次以上吗？一个 mutex 是一个锁。只有一种状态（锁定 / 解锁）与它相关联。然而，一个递归的 mutex（recursive mutex）可以被锁定一次以上（POSIX 兼容系统），其中有一个计数与它相关联，但只保留一个状态（锁定 / 未锁定）。程序员必须使 mutex 解锁的次数与它被锁定的次数相同。</p></li><li><p>如果一个非递归的 mutex 被锁定超过一次，会发生什么？死锁（Deadlock）。如果一个已经锁定的 mutex 的线程，试图再次锁定该 mutex，它将进入该 mutex 的等待列表，这将导致死锁。这是因为没有其他线程可以解锁该 mutex。操作系统的实现者可以谨慎地识别 mutex 的所有者，如果它已经被同一个线程锁定，则返回，以防止死锁。</p></li><li><p>二进制信号量和互斥（mutex）是一样的吗？不，我们建议将它们分开处理，正如在信号量与锁机制中所解释的那样。但是二进制信号量可能会遇到与 mutex 类似的重要问题（例如优先级倒置（priority inversion））。</p></li><li><p>什么是 mutex 和临界区（critical section）？一些操作系统在 API 中使用了相同的单词 critical section。通常情况下，由于与之相关的保护协议（protection protocols），mutex 是一个昂贵的操作。最后，mutex 的目标是原子访问（atomic access）。还有其他的方法来实现原子访问，比如禁用中断（disabling interrupts），这样可以快得多，但会破坏响应性（responsiveness）。替代的 API 使用了禁用中断的方法。</p></li><li><p>什么是事件（events）？mutex、semaphore、event、critical section 等的语义都是一样的，都是同步原语（synchronization primitives）。基于使用它们的成本，它们是不同的。我们应该查阅操作系统文档以了解确切的细节。</p></li><li><p>我们可以在中断服务程序（ISR）中获取 mutex/semaphore 吗？ISR 将在当前运行线程的上下文中异步运行。我们不建议在 ISR 中查询（阻塞调用，blocking call）同步原语的可用性。ISR 是短暂的，对 mutex/semaphore 的调用可能会阻塞当前运行的线程。然而，一个 ISR 可以给 semaphore 发出信号或解锁 mutex。</p></li><li><p>当 mutex/semaphore 不可用时，我们所说的 &quot;线程阻塞在 mutex/semaphore 上&quot; 是什么意思？每个同步原语都有一个与之相关的等待列表（waiting list）。当资源不可用时，请求的线程将从处理器的运行列表（running list）中移到同步原语的等待列表中。当资源可用时，等待列表中优先级较高的线程会获得资源（更准确地说，这取决于调度策略（scheduling policies））。</p></li><li><p>当资源不可用时，线程是否必须一直阻塞？没有必要。如果设计确定 &quot;当资源不可用时必须做什么&quot;，线程可以承担这项工作（不同的代码分支）。为了支持应用需求，操作系统提供了非阻塞的 API。例如，POSIX <code>pthread_mutex_trylock()</code> API。当 mutex 不可用时，函数立即返回，而 API <code>pthread_mutex_lock()</code> 则阻断线程，直到资源可用。</p></li></ol><p>还可以将 mutex/semaphores 与 Peterson 的算法和 Dekker 的算法进行比较。一本好的参考书是《并发的艺术》（《Art of Concurrency book》）。还可以在 Qt 文档中探讨读锁和写锁。</p><h3 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h3><ul><li><a href="https://barrgroup.com/embedded-systems/how-to/rtos-mutex-semaphore" target="_blank" rel="noreferrer">Mutexes and Semaphores Demystified</a></li></ul><h2 id="生产者和消费者问题" tabindex="-1">生产者和消费者问题 <a class="header-anchor" href="#生产者和消费者问题" aria-hidden="true">#</a></h2><p>生产者消费者问题是一个经典的同步问题。我们可以通过使用 semaphores 来解决这个问题。</p><p>一个信号量 S 是一个整数变量，只能通过两个标准操作来访问：wait () 和 signal ()。wait () 操作将 semaphore 的值减少 1，signal () 操作将其值增加 1。</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">S</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">S</span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;">   // busy waiting</span></span>
<span class="line"><span style="color:#F07178;">S</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">S</span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">S</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Semaphores 有两种类型：</p><ul><li>Binary Semaphore - 这类似于 mutex lock，但不是一回事。它只能有两个值 --0 和 1。它的值被初始化为 1。它被用来实现解决多进程的临界区问题。</li><li>Counting Semaphore - 它的值可以在一个不受限制的领域内。它被用来控制对多实例的资源的访问。</li></ul><p>问题描述：</p><p>我们有一个固定大小的缓冲区。一个生产者可以生产项目并将其放在缓冲区（buffer）内。消费者可以挑选物品，也可以消费它们。我们需要确保生产者在将物品放入缓冲区的同时，消费者不应该消费任何物品。在这个问题中，缓冲区是临界区（critical section）。</p><p>为了解决这个问题，我们需要两个计数信号量（counting semaphores）：Full 和 Empty。&quot;Full&quot; 记录任何时候缓冲区内的项目数量，&quot;Empty&quot; 记录未被占用的槽的数量。</p><p>信号量的初始化：</p><ul><li>mutex = 1</li><li>Full = 0 // 初始时，所有槽位都是空的。因此，满槽为 0</li><li>Empty = n // 最初所有的槽都是空的</li></ul><p>生产者的解决方案：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">do</span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//produce an item</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">empty</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//place in buffer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">full</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>当生产者产生一个项目时，&quot;empty&quot; 的值会减少 1，因为现在有一个槽会被填充。mutex 的值也被减少，以防止消费者访问缓冲区。现在，生产者已经放置了物品，因此 &quot;full&quot; 的值增加了 1，mutex 的值也增加了 1，因为生产者的任务已经完成，消费者可以访问缓冲区。</p><p>消费者的解决方案：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">do</span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">full</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// remove item from buffer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">empty</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// consumes item</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>由于消费者正在从缓冲区移除一个项目，因此 &quot;full&quot; 的值减少了 1，mutex 的值也减少了，所以生产者此时不能访问缓冲区。现在，消费者已经消耗了这个项目，因此 &quot;empty&quot; 的值增加了 1，Mutex 的值也增加了，所以生产者现在可以访问缓冲区。</p><p>参考：</p><ul><li><a href="https://www.geeksforgeeks.org/producer-consumer-solution-using-semaphores-java/" target="_blank" rel="noreferrer">Producer-Consumer solution using Semaphores in Java | Set 2 - GeeksforGeeks</a></li></ul><h2 id="用餐哲学家问题" tabindex="-1">用餐哲学家问题 <a class="header-anchor" href="#用餐哲学家问题" aria-hidden="true">#</a></h2><p>吃饭的哲学家问题（The Dining Philosopher Problem）：</p><p>吃饭的哲学家问题指出，K 个哲学家围着一张圆桌子坐着，每对哲学家之间有一根筷子。如果一个哲学家能够拿起与他相邻的两根筷子，他就可以吃饭。一根筷子只可以被其相邻的任何一个人拿起，但不能同时拿起。</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.687emfzduno0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.687emfzduno0.webp"></p><p>每个哲学家都由以下伪代码表示：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">process P</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">do</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">  THINK</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">PICKUP</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CHOPSTICK</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">],</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">CHOPSTICK</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> mod </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"><span style="color:#F07178;">      EAT</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">PUTDOWN</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CHOPSTICK</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">],</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">CHOPSTICK</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> mod </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>哲学家有三种状态。思考、饥饿和进食（THINKING, HUNGRY, and EATING）。这里有两个信号量。Mutex 和一个用于哲学家的信号量数组（semaphore array）。Mutex 的使用使得没有两个哲学家可以在同一时间访问 pickup 或 putdown。数组被用来控制每个哲学家的行为。但是，由于编程错误，信号量可能导致死锁。</p><p>代码：</p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">pthread.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">semaphore.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">stdio.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">N</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">THINKING</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">HUNGRY</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">EATING</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">LEFT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">phnum </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> N</span></span>
<span class="line"><span style="color:#89DDFF;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">RIGHT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">phnum </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> N</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> state</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">N</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> phil</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">N</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sem_t</span><span style="color:#A6ACCD;"> mutex</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#FFCB6B;">sem_t</span><span style="color:#A6ACCD;"> S</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">N</span><span style="color:#89DDFF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">phnum</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> HUNGRY</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">LEFT</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> EATING</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">RIGHT</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> EATING</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// state that eating</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> EATING</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d takes fork %d and %d</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">     phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LEFT </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d is Eating</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// sem_post(&amp;S[phnum]) has no effect</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// during takefork</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// used to wake up hungry philosophers</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// during putfork</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sem_post</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">S</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// take up chopsticks</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">take_fork</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">phnum</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_wait</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// state that hungry</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> HUNGRY</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d is Hungry</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// eat if neighbours are not eating</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">test</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_post</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// if unable to eat wait to be signalled</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_wait</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">S</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// put down chopsticks</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">put_fork</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">phnum</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_wait</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// state that thinking</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">state</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">phnum</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> THINKING</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d putting fork %d and %d down</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> LEFT </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d is thinking</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> phnum </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">test</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">LEFT</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">test</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">RIGHT</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_post</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">philosopher</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">num</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> num</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">take_fork</span><span style="color:#89DDFF;">(*</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">put_fork</span><span style="color:#89DDFF;">(*</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#C792EA;">pthread_t</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">thread_id</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">N</span><span style="color:#89DDFF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;">// initialize the semaphores</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sem_init</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> N</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">sem_init</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">S</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">],</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> N</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;">// create philosopher processes</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">pthread_create</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">thread_id</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">],</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL,</span></span>
<span class="line"><span style="color:#F07178;">     philosopher</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">phil</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Philosopher %d is thinking</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> N</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">++)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">pthread_join</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">thread_id</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">],</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><p>参考：</p><ul><li><a href="https://legacy.cs.indiana.edu/classes/p415-sjoh/hw/project/dining-philosophers/index.htm" target="_blank" rel="noreferrer">The Dining Philosophers Problem</a></li></ul><h2 id="睡眠理发师问题" tabindex="-1">睡眠理发师问题 <a class="header-anchor" href="#睡眠理发师问题" aria-hidden="true">#</a></h2><p>问题：</p><p>有一家理发店，有一个理发师，一张理发椅，如果有顾客坐的话，还有 n 张椅子用来等待顾客。如果没有顾客，那么理发师就睡在自己的椅子上。当有顾客到来时，他必须叫醒理发师。如果有很多顾客，而理发师正在为顾客理发，那么剩下的顾客如果等候室里有空椅子就等待，如果没有空椅子就离开。</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.3gmx7oq52ks0.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.3gmx7oq52ks0.webp"></p><p>解决方案：</p><p>这个问题的解决方案包括三个信号量。第一个信号量是用于计算等待室中的顾客数量（理发师椅子上的顾客不包括在内，因为他没有在等待）。第二，0 或 1 用来告诉理发师是空闲还是在工作，第三个 mutex 用来提供相互排斥，这是进程执行所需要的。在解决方案中，顾客有在等候室等待的顾客数量的记录，如果顾客的数量等于等候室的椅子数量，那么即将到来的顾客就会离开理发店。</p><p>当理发师早上出现时，他执行程序 barber，导致他在 semaphore customers 上阻塞，因为它最初是 0。然后理发师去睡觉，直到第一个顾客出现。</p><p>当一个顾客来的时候，他执行 customer 过程，顾客获得了进入临界区的 mutex，如果此后有另一个顾客进入，第二个顾客将不能做任何事情，直到第一个顾客释放了 mutex。然后，客户检查等待室的椅子，如果等待的客户少于椅子的数量，那么他就坐下，否则他就离开并释放 mutex。</p><p>如果椅子是空的，那么顾客就坐在等候室里，并增加变量 waiting 的值，同时也增加顾客的 semaphore，如果理发师在睡觉，就把他唤醒。</p><p>这时，顾客和理发师都醒了，理发师准备给这个人理发了。理发结束后，顾客退出程序，如果等待室里没有顾客，理发师就会睡觉。</p><p><img data-zooming src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.507t59yumd80.webp" alt="image" data-src="https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.507t59yumd80.webp"></p><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">Semaphore Customers </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">Semaphore Barber </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">Mutex Seats </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> FreeSeats </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> N</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Barber </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">   /* waits for a customer (sleeps). */</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">down</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Customers</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">   /* mutex to protect the number of available seats.*/</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">down</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Seats</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">   /* a chair gets free.*/</span></span>
<span class="line"><span style="color:#F07178;">   FreeSeats</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#676E95;">   /* bring customer for haircut.*/</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">up</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Barber</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#676E95;">   /* release the mutex on the chair.*/</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">up</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Seats</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;">   /* barber is cutting hair.*/</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Customer </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">   /* protects seats so only 1 customer tries to sit</span></span>
<span class="line"><span style="color:#676E95;">   in a chair if that&#39;s the case.*/</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">down</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Seats</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;"> //This line should not be here.</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">FreeSeats </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#676E95;">    /* sitting down.*/</span></span>
<span class="line"><span style="color:#F07178;">    FreeSeats</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#676E95;">    /* notify the barber. */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">up</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Customers</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#676E95;">    /* release the lock */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">up</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Seats</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#676E95;">    /* wait in the waiting room if barber is busy. */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">down</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Barber</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// customer is having hair cut</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">    /* release the lock */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">up</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">Seats</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// customer leaves</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="读写同步问题" tabindex="-1">读写同步问题 <a class="header-anchor" href="#读写同步问题" aria-hidden="true">#</a></h2><p>考虑这样一种情况：我们有一个许多人共享的文件：</p><p>如果其中一个人试图编辑该文件，其他任何人都不应该在同一时间读或写，否则他将看不到变化。然而，如果某个人正在阅读该文件，那么其他人也可能同时阅读它。确切地说，在操作系统中，我们把这种情况称为 &quot;读写问题&quot;（readers-writers problem）。</p><p>问题参数：</p><ul><li>一组数据在多个进程之间共享</li><li>一旦一个写者准备好了，它就进行写。每次只有一个写者可以写</li><li>如果一个进程正在写，其他进程不能读它</li><li>如果至少有一个读者在读，其他进程就不能写。</li><li>读者可以不写，只读</li></ul><p>读者比写者有优先权时的解决方案：</p><p>这里的优先级是指，如果当前的共享被打开用于读取，则没有读者应该等待。使用了三个变量：mutex, wrt, readcnt 来实现解决方案：</p><ul><li>semaphore mutex, wrt。semaphore mutex 用于确保在 readcnt 更新时，即任何读者进入或退出临界区时的相互排斥，semaphore wrt 同时被读者和写者使用。</li><li>int readcnt。readcnt 表示在临界区进行读取的进程数量，最初为 0。</li></ul><p>semaphore 的函数：</p><ul><li>wait () : 递减 semaphore 的值。</li><li>signal ()：增加信号量的值。</li></ul><p>写者进程：</p><ul><li>写入者请求进入临界区。</li><li>如果允许，即 wait () 给出一个真值，它就进入并执行写操作。如果不允许，它将继续等待。</li><li>它退出临界区。</li></ul><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// writer requests for critical section</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">wrt</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// performs the write</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// leaves the critical section</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">wrt</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>读者过程：</p><ul><li>读者要求进入临界区。</li><li>如果允许的话。它将增加临界区中的读者数量。如果这个读者是第一个进入的读者，它会锁定 wrt semaphore，以限制任何写者进入。然后，它向 mutex 发出信号，因为任何其他读者都被允许进入。在进行读取后，它退出临界区。当退出时，它检查是否有更多的读者在里面，如果没有更多读者，它释放信号信量 &quot;wrt&quot;，因为现在写者可以进入临界区。</li><li>如果不允许，它将继续等待。</li></ul><div class="language-c line-numbers-mode"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#89DDFF;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// Reader wants to enter the critical section</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// The number of readers has now increased by 1</span></span>
<span class="line"><span style="color:#F07178;">   readcnt</span><span style="color:#89DDFF;">++;</span><span style="color:#F07178;">                          </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// there is atleast one reader in the critical section</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// this ensure no writer can enter if there is even one reader</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// thus we give preference to readers here</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">readcnt</span><span style="color:#89DDFF;">==</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;">     </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">wrt</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">                    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// other readers can enter while this current reader is inside </span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// the critical section</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">                   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// current reader performs reading here</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">wait</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;">   // a reader wants to leave</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   readcnt</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;">// that is, no reader is left in the critical section,</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">readcnt </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">wrt</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;">         // writers can enter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#82AAFF;">signal</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">mutex</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;"> // reader leaves</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(true);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>因此，信号 &quot;wrt&quot; 在读者和写者之间排队，其方式是如果写者也在那里，则优先考虑读者。因此，没有一个读者仅仅因为一个写作者要求进入临界区而在等待。</p></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-16f25ed6 data-v-956c8bb7><div class="edit-info" data-v-956c8bb7><!----><div class="last-updated" data-v-956c8bb7><p class="VPLastUpdated" data-v-956c8bb7 data-v-93aba522>最近更新: <time datatime="2022-10-28T09:36:55.000Z" data-v-93aba522></time></p></div></div><div class="prev-next" data-v-956c8bb7><div class="pager" data-v-956c8bb7><a class="pager-link prev" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/03-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95" data-v-956c8bb7><span class="desc" data-v-956c8bb7>Previous page</span><span class="title" data-v-956c8bb7>📃 03-操作系统原理之调度算法</span></a></div><div class="has-prev pager" data-v-956c8bb7><a class="pager-link next" href="/CS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/05-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B9%8B%E6%AD%BB%E9%94%81" data-v-956c8bb7><span class="desc" data-v-956c8bb7>Next page</span><span class="title" data-v-956c8bb7>📃 05-操作系统原理之死锁</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-63f8b582 data-v-2ee2d660><div class="container" data-v-2ee2d660><p class="message" data-v-2ee2d660>Released under the MIT License.</p><p class="copyright" data-v-2ee2d660>Copyright © 2022-present, made by Jonsam NG with 💖</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"cs_0-开始上手.md\":\"f5330f41\",\"cs_01-vim操作表.md\":\"fc01cf9a\",\"cs_操作系统_0-操作系统-开始阅读.md\":\"295cc4c8\",\"cs_操作系统_00-操作系统原理之概述.md\":\"0db9a90e\",\"cs_操作系统_01-操作系统原理之进程与线程.md\":\"30b8a291\",\"cs_操作系统_02-操作系统原理之cpu调度.md\":\"54db8d65\",\"cs_操作系统_03-操作系统原理之调度算法.md\":\"6881f685\",\"cs_操作系统_04-操作系统原理之进程同步.md\":\"dec0a76b\",\"cs_操作系统_05-操作系统原理之死锁.md\":\"de678a83\",\"cs_操作系统_06-操作系统原理之内存管理.md\":\"db29166c\",\"cs_操作系统_07-操作系统原理之文件系统.md\":\"027e5938\",\"cs_操作系统_08-操作系统原理之磁盘调度.md\":\"9ffd8cb5\",\"cs_网络原理_0-网络原理-开始阅读.md\":\"1db59654\",\"cs_网络原理_00-计算机网络原理之概述.md\":\"fcd72072\",\"cs_网络原理_01-计算机网络原理之物理层.md\":\"e099b4ee\",\"cs_网络原理_02-计算机网络原理之数据链路层.md\":\"2efa0dc5\",\"cs_网络原理_03-计算机网络原理之网络层.md\":\"5fe66fc2\",\"cs_网络原理_04-计算机网络原理之传输层.md\":\"b74e9e8b\",\"cs_网络原理_05-计算机网络原理之应用层.md\":\"296568b2\",\"dsa_开始上手.md\":\"71ce076f\",\"dsa_数据结构_0-开始阅读.md\":\"7d61c538\",\"dsa_数据结构_00-队列.md\":\"86be27ea\",\"index.md\":\"5b8b4b82\",\"关于.md\":\"61f7820e\",\"示例.md\":\"0cfdf1e1\"}")</script>
    <script type="module" async src="/assets/app.65350cb6.js"></script>
    
  </body>
</html>