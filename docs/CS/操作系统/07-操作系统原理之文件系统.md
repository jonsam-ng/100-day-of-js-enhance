# 操作系统原理之文件系统

<Badges :content="[{type: 'tip', text:'操作系统原理'}]" />

## 目录

[[TOC]]

## 文件系统简介

### 文件

文件（file）是记录在二级存储（secondary storage）上的相关信息的集合（collection）。或者说文件是逻辑上相关实体（logically related entities）的集合。从用户的角度来看，一个文件是逻辑二级存储的最小分配量（smallest allotment）。

文件的名称分为两部分，如下图所示：

- 名称
- 扩展名（extension），用英文句号`.`隔开。

文件属性和它的操作：

| Attributes    | Types | Operations |
| ------------- | ----- | ---------- |
| Name          | Doc   | Create     |
| Type          | Exe   | Open       |
| Size          | Jpg   | Read       |
| Creation Data | Xis   | Write      |
| Author        | C     | Append     |
| Last Modified | Java  | Truncate   |
| protection    | class | Delete     |
|               | Close |            |

| 文件类型       | 常见扩展名           | 功能                                          |
| -------------- | -------------------- | --------------------------------------------- |
| Executable     | exe, com, bin        | 读取并运行机器语言程序                        |
| Object         | obj, o               | 编译过，不链接机器语言                        |
| Source Code    | C, java, pas, asm, a | 各种语言的源代码                              |
| Batch          | bat, sh              | 对命令解释器的命令                            |
| Text           | txt, doc             | 文本数据、文档                                |
| Word Processor | wp, tex, rrf, doc    | 各种文字处理器格式                            |
| Archive        | arc, zip, tar        | 相关文件被打包为一个压缩文件                  |
| Multimedia     | mpeg, mov, rm        | 用于包含音频/视频信息                         |
| Markup         | xml, html, tex       | 它是文本数据和文档                            |
| Library        | lib, a ,so, dll      | 它包含了供程序员使用的程序库                  |
| Print or View  | gif, pdf, jpg        | 它是一种用于打印或查看ASCII或二进制文件的格式 |

### 文件目录

文件的集合就是一个文件目录（file directory）。该目录包含有关文件的信息，包括属性（attributes）、位置（location）和所有权（ownership）。这些信息中的大部分，特别是与存储有关的信息，由操作系统管理。目录本身就是一个文件，可由各种文件管理程序（file management routines）访问。

设备目录中包含的信息有：

- 名称（Name）
- 类型（Type）
- 地址（Address）
- 当前长度（Current length）
- 最大长度（Maximum length）
- 最后访问日期（Date last accessed）
- 最后更新日期（Date last updated）
- 业主身份（Owner id）
- 保护信息（Protection information）

对目录进行的操作是：

- 搜索文件（Search for a file）
- 创建文件（Create a file）
- 删除文件（Delete a file）
- 列出目录（List a directory）
- 重命名文件（Rename a file）
- 遍历文件系统（Traverse the file system）

维护目录的优势在于：

- 效率。可以更快找到文件。
- 命名。它为用户提供了方便，因为两个用户可以为不同的文件使用相同的名称，也可以为同一个文件使用不同的名称。
- 分组。文件的逻辑分组可以通过属性来完成，例如，所有的java程序，所有的游戏等。

单层目录（SINGLE-LEVEL DIRECTORY）：为所有用户维护的一个单一的目录。

- 命名问题（Naming problem）：用户不能对两个文件使用相同的名字。
- 分组问题（Grouping problem）：用户不能根据他们的需要对文件进行分组。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.5vqb87ixk140.webp)

双层目录：每个用户都有单独的目录被维护。

- 路径名称：由于两级目录，每个文件都有一个路径名称来定位该文件。
- 可以为不同的用户提供相同的文件名。
- 搜索是高效的。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6dvmc8qfews0.webp)

树状结构的目录：目录是以树状形式维护的。搜索高效，也有分组的能力。我们对一个文件有绝对或相对的路径（absolute or relative path）名称。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.47skkxb8u3s0.webp)

## 文件分配方法

### 连续分配（Continuous Allocation）

在创建文件时，为文件分配一套单一的连续块（single continuous set of blocks）。因此，这是一种预分配策略（pre-allocation strategy），使用可变大小的分区（variable size portions）。文件分配表（file allocation table）对每个文件只需要一个条目，显示起始块（ starting block）和文件的长度。从单个顺序文件的角度来看，这种方法是最好的。一次可以读入多个块，以提高顺序处理（sequential processing）的I/O性能。检索单个块也很容易。例如，如果一个文件从b块开始，想要该文件的第i个块，它在二级存储中的位置只是`b+i-1`。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6dp0uezeilc0.webp)

劣势：

- 会出现外部碎片（External fragmentation），使其难以找到足够长度的连续空间块。将有必要采用压缩算法（Compaction algorithm）来释放磁盘上的额外空间。
- 在预分配（pre-allocation）的情况下，有必要在创建时声明文件的大小。

### 链接分配（Linked Allocation）

链接分配（Linked Allocation），即非连接分配（Non-contiguous allocation）。分配是在单个块的基础上进行的。每个区块都包含一个指向链中下一个区块的指针。同样，文件表（file table）对每个文件只需要一个条目，显示起始块和文件的长度。尽管预分配是可能的，但更常见的是根据需要分配块。任何空闲的块都可以被添加到链上，且这些块不需要是连续的。如果有可用的磁盘块，增加文件大小总是可能的。没有外部碎片，因为每次只需要一个块，但可能有内部碎片（internal fragmentation），但它只存在于文件的最后一个磁盘块。

缺点：

- 内部碎片存在于文件的最后一个磁盘块中。
- 维护每个磁盘块的指针是一种开销。
- 如果任何磁盘块的指针丢失，文件将被截断(truncated)。
- 它只支持文件的顺序访问（sequential access）。

### 索引式分配（Indexed Allocation）

它解决了许多连续和链式分配的问题。在这种情况下，文件分配表（file allocation table）为每个文件包含一个单独的单级索引（one-level index）。该索引对分配给文件的每个块都有一个条目。分配可能是基于固定大小的块或可变大小的块。按块分配消除了外部碎片，而按可变大小的块（variable-size blocks）分配则提高了位置灵活性（locality）。这种分配技术同时支持对文件的顺序和直接访问，因此是最流行的文件分配形式。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.8xzrtm3bcs0.webp)

磁盘空闲空间管理:

正如必须对分配给文件的空间进行管理一样，也必须对当前未分配给任何文件的空间进行管理。为了执行任何文件分配技术，有必要知道磁盘上有哪些块是可用的。因此，除了文件分配表（file allocation table）之外，我们还需要一个磁盘分配表（disk allocation table）。以下是用于空闲空间管理的方法：

- 位表（Bit Tables）：这种方法使用一个向量，包含磁盘上每个块的一个比特。0对应于一个空闲块，1对应于一个正在使用的块。例如：00011010111100110001，在这个向量中，每一个比特都对应于一个特定的块，0意味着该特定的块是空闲的，1意味着该块已经被占用。位表的优点是比较容易找到一个或一组连续的空闲块。因此，位表与任何一种文件分配方法都能很好地工作。另一个优点是它足够的小。
- 空闲区块列表（Free Block List）：在这种方法中，每个区块都被按顺序分配一个号码，所有空闲区块的号码列表被保存在磁盘的一个保留区（reserved block）中。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.670yutlnz8o0.webp)
