# 计算机网络原理之传输层

<Badges :content="[{type: 'tip', text:'计算机网络'}]" />

## 目录

[[TOC]]

## 韩立刚计算机网络：传输层

<Pdf src="/韩立刚计算机网络/第08章 传输层.pdf" />

## 传输层的两个协议

### TCP 和 UDP 的应用场景

网络中的计算机通信无外乎有以下两种情况：  

- 要发送的内容多，需要将发送的内容分成多个数据包发送。  
- 要发送的内容少，一个数据包就能发送全部内容。

针对这两种情况，在传输层有两个协议，TCP（Transmission Control Protocol 即传输控制协议）和 UDP（User Datagram Protocol 即用户数据报协议）。

### 传输层协议和应用层协议之间的关系

应用层协议很多，传输层就两个协议，如何使用传输层两个协议标识应用层协议呢？传输层协议加一个端口号来标识一个应用层协议，展示了传输层协议和应用层协议之间的关系。  

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.5hcajeks2rw0.webp)

**一些常见的应用层协议和传输层协议，以及它们之间的关系**：

- HTTP 默认使用 TCP 的 80 端口标识。
- FTP 默认使用 TCP 的 21 端口标识。
- SMTP 默认使用 TCP 的 25 端口标识。
- POP3 默认使用 TCP 的 110 端口。
- HTTPS 默认使用 TCP 的 443 端口。
- DNS 使用 UDP 的 53 端口。
- 远程桌面协议（RDP）默认使用 TCP 的 3389 端口。
- Telnet 使用 TCP 的 23 端口。
- Windows 访问共享资源使用 TCP 的 445 端口。
- 微软 SQL 数据库默认使用 TCP 的 1433 端口。
- mySQL 数据库默认使用 TCP 的 3306 端口。

### 服务和端口之间的关系

Windows 和 Linux 操作系统有些服务为本地计算机提供服务，有些服务为网络中的计算机提供服务。为网络中计算机提供服务的服务，一旦启动就会使用 TCP 或 UDP 的某个端口侦听客户端的请求。  

## 用户数据报协议 UDP

### UDP 协议的特点

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6boukqv9ziw0.webp)

- UDP 是无连接的，即发送数据之前不需要建立连接（当然发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
- UDP 使用**尽最大努力交付**，即不保证可靠交付，因此主机不需要维持复杂的连接状态表（这里面有许多参数），通信的两端不用保持连接，因此节省系统资源。
- UDP 是**面向报文**的，发送方的 UDP 对应用程序交下来的报文，在添加首部后就向下交付给网络层。UDP 对应用层交下来的报文，**既不合并，也不拆分**，而是保留这些报文的边界。  
- UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。
- UDP 支持一对一、一对多、多对一和多对多的交互通信。
- UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短。

### UDP 的首部格式

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1n5zmohrljnk.webp)

UDP 的首部包括四个字段，源端口、目标端口、长度和校验和，每个字段的长度是两个字节。**伪首部**包括：源地址、目的地址、UDP 数据长度、协议类型（0x11），协议类型就一个字节，但需要补一个字节的 0x0，构成 12 个字节。  

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.gh2ccf00at4.webp)

**计算 UDP 检验和的例子**：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.66cg82shxp80.webp)

## 传输控制协议 TCP

### TCP 协议主要的特点

- TCP 是面向连接的传输层协议。这就是说，应用程序在使用 TCP 协议之前，必须 先建立 TCP 连接。在传送数据完毕后，必须释放已经建立的 TCP 连接。这就是说，应用 进程之间的通信好像在 “打电话”：通话前要先拨号建立连接，通话结束后要挂机释放连接。
- 每一条 TCP 连接只能有两个端点（endpoint），每一条 TCP 连接只能是点对点的 （一对一）。
- TCP 提供**可靠交付的服务**。也就是说，通过 TCP 连接传送的数据，无差错、不丢失、不重复、且按序发送。
- TCP 提供**全双工通信**。TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有**发送缓存和接收缓存**，用来临时存放双向通信的数据。在发送时，应用程序把数据传送给 TCP 的缓存后，就可以做自己的事，而 TCP 在合适的时候把数据发送出去。在接收时，TCP 把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。
- **面向字节流**。TCP 中的 “流”（steam）指的是流入到进程或从进程流出的字节序列。  

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.fot0gm9ceaw.webp)

### TCP 报文的首部格式

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.12zmciccrtow.webp)

TCP 协议是能够实现数据分段传输、可靠传输、流量控制、网络拥塞避免等功能，因此 TCP 报文的首部要比 UDP 报文首部字段要多，并且首部长度不固定。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.5y2auytsjn00.webp)

- 源端口和目的端口：各占 2 个字节，分别写入源端口号和目的端口号。和前面图所示的 UDP 的分用相似，TCP 的分用功能也是通过端口实现的。
- 序号：占 4 字节。序号范围是 [0，232-1]，共 232（即 4 294 967 296）个序号。序号增加到 232-1 后，下一个序号就又回到 0。TCP 是面向字节流的。在一个 TCP 连接中传送的字节流中的每一个字节都按顺序编号。
- 确认号：占 4 字节，是期望收到对方下一个报文段的第一个数据字节的序号。
  - TCP 协议能够实现可靠传输，接收方收到几个数据包后，就会给发送方一个确认数据包，告诉发送方下一个数据包该发第多少个字节了。
  - 若确认号是 N，则表明：到序号 N-1 为止的所有数据都已正确收到。
- 数据偏移：占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。这个字段实际上是指出 TCP 报文段的首部长度。由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的。但请注意，“数据偏移” 的单位为 4 字节，由于 4 位二进制数能够表示的最大十进制数字是 15，因此数据偏移的最大值是 60 字节，这也是 TCP 首部的最大长度，这也就意味着选项长度不能超过 40 字节。
- 保留：占 6 位，保留为今后使用，但目前应置为 0。
- 紧急：URG（URGent） 当 URG=l 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据），而不要按原来的排队顺序来传送。
- 确认：ACK（ACKnowlegment） 仅当 ACK=1 时确认号字段才有效。当 ACK=0 时，确认号无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。‘
- 推送：PSH（PuSH） 当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应。
- 复位：RST（ReSeT） 当 RST=l 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
- 同步：SYN（SYNchronization） 在连接建立时用来同步序号。当 SYN=1 而 ACK=0 时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使 SYN=1 和 ACK=1。因此，SYN 置为 1 就表示这是一个连接请求或连接接受报文。
- 终止：FIN（FINish 意思是 “完”、“终”） 用来释放一个连接。当 FIN=1 时，表明此报文段的发送方的数据己发送完毕，并要求释放传输连接。
- 窗口：占 2 字节。窗口值是 [0，216-1] 之间的整数。TCP 协议有流量控制功能，窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（单位是字节）。
- 检验和：占 2 字节。检验和字段检验的范围包括首部和数据这两部分。和 UDP 用户数据报一样，在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。
- 紧急指针：占 2 字节。紧急指针仅在 URG=1 时才有意义，它指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据）。因此紧急指针指出了紧急数据的末尾在报文段中的位置。
- 选项：长度可变，最长可达 40 个字节。当没有使用选项时，TCP 的首部长度是 20 字节。TCP 最初只规定了一种选项，即最大报文段长度 MSS（Maximum Segment Size）。

## 可靠传输

### TCP 可靠传输的实现 - 停止等待协议

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.2i1g90mxqfw0.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.5zz12al7gi80.webp)

### 连续 ARQ 协议和互动窗口协议 - 改进的停止等待协议

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.79zzcfcuoms0.webp)

### 以字节为单位的滑动窗口技术详解

滑动窗口是面向字节流的，为了方便大家记住每个分组的序号，下面的讲解每一个分组就假设 100 个字节，为了方便画图表示，将分组进行编号简化表示，如图所示，不过你要记住，每一个分组的序号是多少。  

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.3fvtsn42oqc.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.fm1ref85k1k.webp)

### 改进的确认 - 选择确认（SACK）

TCP 通信时，如果发送序列中间某个数据包丢失，TCP 会通过重传最后确认的分组后续的分组，这样原先已经正确传输的分组也可能重复发送，降低了 TCP 性能。为改善这种情况，发展出 SACK（Selective Acknowledgment，选择确认）技术，使 TCP 只重新发送丢失的包，不用发送后续所有的分组，而且提供相应机制使接收方能告诉发送方哪些数据丢失，哪些数据已经提前收到等。  

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.hf19kkdbets.webp)

**选择性确认最多表示 4 个边界**：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.4jt4gs4x34o0.webp)

### 超时重传的时间调整

TCP 的发送方在规定的时间内没有收到确认就要重传己发送的报文段。这种重传的概念是很简单的，但重传时间的选择却是 TCP 最复杂的问题之一。传输层的超时计时器的超时重传时间究竟应设置为多大呢？TCP 往返传输时间 （RTT） 的测量可以采用两种方法：

- TCP Timestamp 选项：TCP 时间戳选项可以用来精确的测量 RTT。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段值复制到时间戳回送回答字段。 因此，发送方在收到确认报文后，可以准确地计算出 RTT 来。RTT = 当前时间 - 数据包中 Timestamp 选项的回显时间。

- 重传队列中数据包的 TCP 控制块：在 TCP 发送窗口中保存着发送而未被确认的数据包，数据包 skb 中的 TCP 控制块包含着一个变量， tcp_skb_cb when，记录了该数据包的第一次发送时间，当收到该数据包确认， 就可以计算 RTT，RTT = 当前时间 - when。这就意味着发送端收到一个确认，就能计算新 的 RTT。

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.76gyod645m80.webp)

**RTT 调整**：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.7is1ufs2lwo0.webp)

**超时计时器设置的超时重传时间 RTO**：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.596dlhwzdyc0.webp)

## 流量控制

## 拥塞控制

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.115ne8v4d9hs.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1jfonj10ym4g.webp)

### 拥塞控制的原理

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6exfi7t5bng0.webp)

### 拥塞控制方法 - 慢开始和拥塞避免

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.3guelzm9sf60.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1qpaxkirzy00.webp)

### 拥塞控制方法 - 快重传和快恢复

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6358x50u3o00.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.4c2depogcjq0.webp)

### 发送窗口的上限

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.3bpzdoek8j20.webp)

## TCP 连接管理

### TCP 的连接建立

请求建立 TCP 连接的数据包：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.5rx5gdaro6w0.webp)

TCP 连接建立的数据包:

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.6d1kkwsgnvg.webp)

确认的确认:

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.49wynat9ifo.webp)

TCP 连接建立的过程：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.7dpzor1kwlo0.webp)

### TCP 连接释放

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.246c58450vi8.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.ghcz6990jg0.webp)

查看 TCP 连接释放的数据包：

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1kue6cd8k9wg.webp)

![image](https://cdn.staticaly.com/gh/jonsam-ng/image-hosting@master/2022/image.1w5jj04j7rog.webp)

## 来源文章

- [计算机网络原理笔记 精整理 第五章 传输层](https://blog.csdn.net/LeeQiang8023/article/details/106174218)